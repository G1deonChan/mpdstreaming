<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MPD流媒体管理演示</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }
        .header-gradient {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border-radius: 20px 20px 0 0;
        }
        .stream-card {
            transition: all 0.3s ease;
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .stream-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        .status-running {
            border-left: 5px solid #28a745;
            background: linear-gradient(135deg, #d4edda 0%, #f8f9fa 100%);
        }
        .status-stopped {
            border-left: 5px solid #dc3545;
            background: linear-gradient(135deg, #f8d7da 0%, #f8f9fa 100%);
        }
        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 12px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            word-break: break-all;
            position: relative;
        }
        .copy-button {
            position: absolute;
            top: 8px;
            right: 8px;
            padding: 4px 8px;
            font-size: 0.75em;
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
        }
        .btn-gradient {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border: none;
            color: white;
        }
        .btn-gradient:hover {
            background: linear-gradient(135deg, #3d8bfe 0%, #0dcaf0 100%);
            color: white;
        }
    </style>
</head>
<body>
    <div class="container-fluid p-4">
        <div class="main-container">
            <!-- 头部 -->
            <div class="header-gradient text-white p-4">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h1 class="mb-2"><i class="fas fa-video me-3"></i>MPD流媒体管理系统</h1>
                        <p class="mb-0 opacity-75">实时MPD到HLS转换与管理平台</p>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="d-flex justify-content-end gap-2">
                            <button class="btn btn-light btn-sm" onclick="location.reload()">
                                <i class="fas fa-sync-alt me-1"></i>刷新
                            </button>
                            <button class="btn btn-outline-light btn-sm" onclick="showHelp()">
                                <i class="fas fa-question-circle me-1"></i>帮助
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="p-4">
                <div class="row g-4">
                    <!-- 左侧面板 -->
                    <div class="col-lg-4">
                        <!-- 系统状态 -->
                        <div class="card stats-card mb-4">
                            <div class="card-body">
                                <h5 class="card-title"><i class="fas fa-heartbeat me-2"></i>系统状态</h5>
                                <div id="health-status" class="text-center py-3">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">检查中...</span>
                                    </div>
                                </div>
                                <div class="row text-center mt-3">
                                    <div class="col-6">
                                        <h3 class="mb-1" id="total-streams">0</h3>
                                        <small>总流数</small>
                                    </div>
                                    <div class="col-6">
                                        <h3 class="mb-1" id="running-streams">0</h3>
                                        <small>运行中</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 快速操作 -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-bolt me-2"></i>快速操作</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    <button class="btn btn-success" onclick="startAllStreams()">
                                        <i class="fas fa-play me-2"></i>启动全部流
                                    </button>
                                    <button class="btn btn-warning" onclick="stopAllStreams()">
                                        <i class="fas fa-stop me-2"></i>停止全部流
                                    </button>
                                    <button class="btn btn-gradient" onclick="showAddModal()">
                                        <i class="fas fa-plus me-2"></i>添加新流
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- 使用说明 -->
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>使用说明</h6>
                            </div>
                            <div class="card-body">
                                <ol class="mb-0 small">
                                    <li>添加MPD流配置</li>
                                    <li>启动流进行转换</li>
                                    <li>获取HLS播放地址</li>
                                    <li>在播放器中使用HLS地址</li>
                                </ol>
                            </div>
                        </div>
                    </div>

                    <!-- 主内容区 -->
                    <div class="col-lg-8">
                        <!-- 状态消息 -->
                        <div id="alert-container"></div>

                        <!-- 流列表 -->
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="fas fa-list me-2"></i>流管理</h5>
                                <button class="btn btn-outline-primary btn-sm" onclick="loadStreams()">
                                    <i class="fas fa-sync-alt me-1"></i>刷新
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="streams-container">
                                    <div class="text-center py-5">
                                        <div class="spinner-border text-primary" role="status"></div>
                                        <p class="mt-3 text-muted">加载流列表中...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加流模态框 -->
    <div class="modal fade" id="addStreamModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-plus-circle me-2"></i>添加新流</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addStreamForm">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">流名称 *</label>
                                <input type="text" class="form-control" name="name" required placeholder="例如: 示例频道">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">流状态</label>
                                <div class="form-check form-switch mt-2">
                                    <input class="form-check-input" type="checkbox" name="enabled" checked>
                                    <label class="form-check-label">启用流</label>
                                </div>
                            </div>
                            <div class="col-12">
                                <label class="form-label">MPD流地址 *</label>
                                <input type="url" class="form-control" name="url" required placeholder="https://example.com/stream.mpd">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">许可证类型</label>
                                <select class="form-select" name="license_type" onchange="toggleLicenseKey()">
                                    <option value="">无</option>
                                    <option value="clearkey">ClearKey</option>
                                </select>
                            </div>
                            <div class="col-md-6" id="licenseKeyGroup" style="display: none;">
                                <label class="form-label">许可证密钥</label>
                                <input type="text" class="form-control" name="license_key" placeholder="key_id:key_value">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="addStream()">
                        <span id="addStreamSpinner" class="spinner-border spinner-border-sm me-2" style="display: none;"></span>
                        添加流
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 编辑流模态框 -->
    <div class="modal fade" id="editStreamModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title"><i class="fas fa-edit me-2"></i>编辑流配置</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editStreamForm">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">流名称 *</label>
                                <input type="text" class="form-control" name="name" required placeholder="例如: 示例频道">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">流状态</label>
                                <div class="form-check form-switch mt-2">
                                    <input class="form-check-input" type="checkbox" name="enabled">
                                    <label class="form-check-label">启用流</label>
                                </div>
                            </div>
                            <div class="col-12">
                                <label class="form-label">MPD流地址 *</label>
                                <input type="url" class="form-control" name="url" required placeholder="https://example.com/stream.mpd">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">许可证类型</label>
                                <select class="form-select" name="license_type" onchange="toggleEditLicenseKey()">
                                    <option value="">无</option>
                                    <option value="clearkey">ClearKey</option>
                                </select>
                            </div>
                            <div class="col-md-6" id="editLicenseKeyGroup" style="display: none;">
                                <label class="form-label">许可证密钥</label>
                                <input type="text" class="form-control" name="license_key" placeholder="key_id:key_value">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-warning" onclick="updateStream()">
                        <span id="editStreamSpinner" class="spinner-border spinner-border-sm me-2" style="display: none;"></span>
                        <i class="fas fa-save me-1"></i>保存更改
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let streams = [];
        let addStreamModal;
        let editStreamModal;
        let currentEditingStreamId = null;

        document.addEventListener('DOMContentLoaded', function() {
            addStreamModal = new bootstrap.Modal(document.getElementById('addStreamModal'));
            editStreamModal = new bootstrap.Modal(document.getElementById('editStreamModal'));
            init();
        });

        async function init() {
            await checkHealth();
            await loadStreams();
            
            // 每30秒检查健康状态
            setInterval(checkHealth, 30000);
            // 每10秒更新流状态
            setInterval(updateStreamStatus, 10000);
        }

        async function checkHealth() {
            try {
                const response = await fetch('/health');
                const data = await response.json();
                
                document.getElementById('health-status').innerHTML = `
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <i class="fas fa-check-circle text-success fs-4"></i>
                            <strong class="ms-2">正常运行</strong>
                        </div>
                        <small class="text-light opacity-75">活跃: ${data.active_streams || 0}</small>
                    </div>
                    <small class="text-light opacity-75 mt-2 d-block">更新: ${new Date().toLocaleString()}</small>
                `;
            } catch (error) {
                document.getElementById('health-status').innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-exclamation-triangle text-warning fs-4"></i>
                        <div class="mt-2">
                            <strong>连接失败</strong><br>
                            <small class="opacity-75">${error.message}</small>
                        </div>
                    </div>
                `;
            }
        }

        async function loadStreams() {
            try {
                const response = await fetch('/streams');
                const data = await response.json();
                streams = data.streams || [];
                
                renderStreams();
                updateStats();
            } catch (error) {
                showAlert('加载流列表失败: ' + error.message, 'danger');
            }
        }

        function renderStreams() {
            const container = document.getElementById('streams-container');
            
            if (streams.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-inbox fs-1 text-muted mb-3"></i>
                        <h5 class="text-muted">暂无流配置</h5>
                        <p class="text-muted">点击"添加新流"开始配置您的第一个流</p>
                        <button class="btn btn-primary" onclick="showAddModal()">
                            <i class="fas fa-plus me-2"></i>添加流
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = streams.map(stream => `
                <div class="card stream-card mb-3 status-${stream.status}">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h6 class="card-title mb-1">
                                    <i class="fas fa-tv me-2"></i>${escapeHtml(stream.name)}
                                    <span class="badge bg-${getStatusColor(stream.status)} ms-2">${getStatusText(stream.status)}</span>
                                    ${stream.process_status && stream.process_status !== 'stopped' ? 
                                        `<span class="badge bg-secondary ms-1">${stream.process_status}</span>` : ''}
                                </h6>
                                <small class="text-muted d-block mb-2">ID: ${stream.id}</small>
                                <p class="card-text mb-2">
                                    <strong>源:</strong> <code class="small">${escapeHtml(stream.url)}</code>
                                    ${stream.license_type ? `<span class="badge bg-info ms-2">${stream.license_type.toUpperCase()}</span>` : ''}
                                    ${stream.method ? `<span class="badge bg-secondary ms-2">${stream.method === 'decryption' ? '解密' : 'FFmpeg'}</span>` : ''}
                                    ${!stream.enabled ? '<span class="badge bg-warning ms-2">已禁用</span>' : ''}
                                </p>
                                ${stream.output_info && stream.output_info.segment_count > 0 ? `
                                    <small class="text-success">
                                        <i class="fas fa-check-circle me-1"></i>
                                        已生成 ${stream.output_info.segment_count} 个视频片段
                                    </small>
                                ` : (stream.status === 'running' ? `
                                    <small class="text-warning">
                                        <i class="fas fa-clock me-1"></i>正在生成视频片段...
                                    </small>
                                ` : '')}
                                ${stream.process_info && stream.process_info.restart_count > 0 ? `
                                    <small class="text-warning d-block">
                                        <i class="fas fa-exclamation-triangle me-1"></i>
                                        已重启 ${stream.process_info.restart_count} 次
                                    </small>
                                ` : ''}
                                ${stream.status === 'running' && stream.hls_url ? `
                                    <div class="code-block position-relative">
                                        <strong>HLS播放地址:</strong><br>
                                        ${window.location.origin}${stream.hls_url}
                                        <button class="btn btn-outline-light btn-sm copy-button" onclick="copyToClipboard('${window.location.origin}${stream.hls_url}')">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                            <div class="col-md-4">
                                <div class="d-grid gap-2">
                                    ${stream.status === 'running' ? 
                                        `<button class="btn btn-warning btn-sm" onclick="stopStream('${stream.id}')">
                                            <i class="fas fa-stop me-1"></i>停止
                                        </button>` :
                                        `<button class="btn btn-success btn-sm" onclick="startStream('${stream.id}')" ${!stream.enabled ? 'disabled' : ''}>
                                            <i class="fas fa-play me-1"></i>启动
                                        </button>`
                                    }
                                    <button class="btn btn-outline-primary btn-sm" onclick="editStream('${stream.id}')">
                                        <i class="fas fa-edit me-1"></i>编辑
                                    </button>
                                    <button class="btn btn-outline-info btn-sm" onclick="testStreamUrl('${stream.id}')">
                                        <i class="fas fa-flask me-1"></i>测试源
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm" onclick="deleteStream('${stream.id}')">
                                        <i class="fas fa-trash me-1"></i>删除
                                    </button>
                                    ${stream.status === 'running' && stream.hls_url ? 
                                        `<button class="btn btn-info btn-sm" onclick="testHlsPlayback('${stream.id}')">
                                            <i class="fas fa-play-circle me-1"></i>测试播放
                                        </button>` : ''
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateStats() {
            document.getElementById('total-streams').textContent = streams.length;
            document.getElementById('running-streams').textContent = streams.filter(s => s.status === 'running').length;
        }

        async function updateStreamStatus() {
            if (streams.length === 0) return;
            
            try {
                const promises = streams.map(stream => 
                    fetch(`/streams/${stream.id}/status`)
                        .then(r => r.json())
                        .catch(() => null)
                );
                
                const statuses = await Promise.all(promises);
                let hasChanges = false;

                statuses.forEach((status, index) => {
                    if (status && streams[index].status !== status.status) {
                        streams[index].status = status.status;
                        streams[index].running = status.running;
                        hasChanges = true;
                    }
                });

                if (hasChanges) {
                    renderStreams();
                    updateStats();
                }
            } catch (error) {
                console.warn('Failed to update stream statuses:', error);
            }
        }

        function showAddModal() {
            document.getElementById('addStreamForm').reset();
            toggleLicenseKey();
            addStreamModal.show();
        }

        function toggleLicenseKey() {
            const licenseType = document.querySelector('select[name="license_type"]').value;
            const keyGroup = document.getElementById('licenseKeyGroup');
            keyGroup.style.display = licenseType === 'clearkey' ? 'block' : 'none';
        }

        async function addStream() {
            const form = document.getElementById('addStreamForm');
            const formData = new FormData(form);
            const spinner = document.getElementById('addStreamSpinner');
            
            const data = {
                name: formData.get('name'),
                url: formData.get('url'),
                license_type: formData.get('license_type') || undefined,
                license_key: formData.get('license_key') || undefined,
                manifest_type: 'mpd',
                enabled: formData.has('enabled')
            };

            spinner.style.display = 'inline-block';

            try {
                const response = await fetch('/streams', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    showAlert(`流添加成功！流ID: ${result.stream_id}`, 'success');
                    addStreamModal.hide();
                    await loadStreams();
                } else {
                    showAlert('添加失败: ' + result.error, 'danger');
                }
            } catch (error) {
                showAlert('网络错误: ' + error.message, 'danger');
            } finally {
                spinner.style.display = 'none';
            }
        }

        async function startStream(streamId) {
            try {
                const response = await fetch(`/streams/${streamId}/start`, { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    showAlert(`流 ${streamId} 启动成功`, 'success');
                    updateStreamInList(streamId, { status: 'starting' });
                } else {
                    showAlert('启动失败: ' + result.error, 'danger');
                }
            } catch (error) {
                showAlert('启动失败: ' + error.message, 'danger');
            }
        }

        async function stopStream(streamId) {
            try {
                const response = await fetch(`/streams/${streamId}/stop`, { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    showAlert(`流 ${streamId} 停止成功`, 'success');
                    updateStreamInList(streamId, { status: 'stopped' });
                } else {
                    showAlert('停止失败: ' + result.error, 'danger');
                }
            } catch (error) {
                showAlert('停止失败: ' + error.message, 'danger');
            }
        }

        async function deleteStream(streamId) {
            if (!confirm(`确定要删除流 ${streamId} 吗？此操作不可撤销。`)) return;
            
            try {
                const response = await fetch(`/streams/${streamId}`, { method: 'DELETE' });
                const result = await response.json();
                
                if (result.success) {
                    showAlert(`流 ${streamId} 删除成功`, 'success');
                    await loadStreams();
                } else {
                    showAlert('删除失败: ' + result.error, 'danger');
                }
            } catch (error) {
                showAlert('删除失败: ' + error.message, 'danger');
            }
        }

        async function startAllStreams() {
            const enabledStreams = streams.filter(s => s.enabled && s.status === 'stopped');
            if (enabledStreams.length === 0) {
                showAlert('没有可启动的流', 'info');
                return;
            }

            showAlert(`正在启动 ${enabledStreams.length} 个流...`, 'info');
            
            for (const stream of enabledStreams) {
                await startStream(stream.id);
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
        }

        async function stopAllStreams() {
            const runningStreams = streams.filter(s => s.status === 'running');
            if (runningStreams.length === 0) {
                showAlert('没有正在运行的流', 'info');
                return;
            }

            showAlert(`正在停止 ${runningStreams.length} 个流...`, 'info');
            
            for (const stream of runningStreams) {
                await stopStream(stream.id);
            }
        }

        function testStream(streamId) {
            const stream = streams.find(s => s.id === streamId);
            if (!stream || stream.status !== 'running') return;
            
            const hlsUrl = `${window.location.origin}${stream.hls_url}`;
            const vlcUrl = `vlc://${hlsUrl}`;
            
            // 尝试用VLC打开
            window.open(vlcUrl, '_blank');
            showAlert('已尝试用VLC打开，如果无法打开请复制HLS地址到播放器', 'info');
        }

        function editStream(streamId) {
            const stream = streams.find(s => s.id === streamId);
            if (!stream) {
                showAlert('找不到指定的流', 'error');
                return;
            }

            currentEditingStreamId = streamId;
            
            // 填充编辑表单
            const form = document.getElementById('editStreamForm');
            form.querySelector('[name="name"]').value = stream.name || '';
            form.querySelector('[name="url"]').value = stream.url || '';
            form.querySelector('[name="enabled"]').checked = stream.enabled !== false;
            form.querySelector('[name="license_type"]').value = stream.license_type || '';
            form.querySelector('[name="license_key"]').value = stream.license_key || '';
            
            // 根据许可证类型显示/隐藏密钥输入框
            toggleEditLicenseKey();
            
            editStreamModal.show();
        }

        function toggleEditLicenseKey() {
            const licenseType = document.querySelector('#editStreamForm [name="license_type"]').value;
            const licenseKeyGroup = document.getElementById('editLicenseKeyGroup');
            if (licenseType === 'clearkey') {
                licenseKeyGroup.style.display = 'block';
            } else {
                licenseKeyGroup.style.display = 'none';
            }
        }

        async function updateStream() {
            if (!currentEditingStreamId) {
                showAlert('没有选择要编辑的流', 'error');
                return;
            }

            const form = document.getElementById('editStreamForm');
            const spinner = document.getElementById('editStreamSpinner');
            
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const formData = new FormData(form);
            const streamData = {
                name: formData.get('name'),
                url: formData.get('url'),
                enabled: formData.has('enabled'),
                license_type: formData.get('license_type') || null,
                license_key: formData.get('license_key') || null
            };

            // 如果没有选择许可证类型，清空密钥
            if (!streamData.license_type) {
                streamData.license_key = null;
            }

            spinner.style.display = 'inline-block';

            try {
                const response = await fetch(`/streams/${currentEditingStreamId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(streamData)
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('流配置更新成功！', 'success');
                    editStreamModal.hide();
                    form.reset();
                    currentEditingStreamId = null;
                    await loadStreams();
                } else {
                    showAlert(result.error || '更新失败', 'error');
                }
            } catch (error) {
                showAlert('网络错误: ' + error.message, 'error');
            } finally {
                spinner.style.display = 'none';
            }
        }

        async function copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
                showAlert('地址已复制到剪贴板', 'success');
            } catch (error) {
                showAlert('复制失败，请手动复制', 'warning');
            }
        }

        function updateStreamInList(streamId, updates) {
            const index = streams.findIndex(s => s.id === streamId);
            if (index !== -1) {
                streams[index] = { ...streams[index], ...updates };
                renderStreams();
                updateStats();
            }
        }

        function getStatusText(status) {
            const texts = {
                'running': '运行中',
                'stopped': '已停止',
                'starting': '启动中',
                'stopping': '停止中'
            };
            return texts[status] || status;
        }

        function getStatusColor(status) {
            const colors = {
                'running': 'success',
                'stopped': 'danger',
                'starting': 'warning',
                'stopping': 'warning'
            };
            return colors[status] || 'secondary';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showAlert(message, type) {
            const alertContainer = document.getElementById('alert-container');
            const alertId = 'alert-' + Date.now();
            
            alertContainer.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" id="${alertId}">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            setTimeout(() => {
                const alertElement = document.getElementById(alertId);
                if (alertElement) {
                    bootstrap.Alert.getOrCreateInstance(alertElement).close();
                }
            }, 5000);
        }

        async function testStreamUrl(streamId) {
            try {
                const response = await fetch(`/streams/${streamId}/test`);
                const result = await response.json();
                
                if (result.success) {
                    const test = result.test_result;
                    const statusIcon = test.accessible ? '✅' : '❌';
                    const statusText = test.accessible ? '可访问' : '无法访问';
                    
                    let message = `
                        <strong>流源测试结果</strong><br>
                        ${statusIcon} <strong>状态:</strong> ${statusText}<br>
                        <strong>URL:</strong> ${test.url}<br>
                        <strong>HTTP状态:</strong> ${test.status_code}<br>
                        <strong>内容类型:</strong> ${test.content_type}<br>
                        <strong>服务器:</strong> ${test.server}
                    `;
                    
                    if (test.accessible && test.is_mpd !== undefined) {
                        message += `<br><strong>MPD格式:</strong> ${test.is_mpd ? '✅ 有效' : '❌ 无效'}`;
                    }
                    
                    if (test.content_preview) {
                        message += `<br><strong>内容预览:</strong><br><code class="small">${escapeHtml(test.content_preview)}</code>`;
                    }
                    
                    showAlert(message, test.accessible ? 'success' : 'danger');
                } else {
                    showAlert(`测试失败: ${result.error}`, 'danger');
                }
            } catch (error) {
                showAlert(`测试失败: ${error.message}`, 'danger');
            }
        }

        async function testHlsPlayback(streamId) {
            const stream = streams.find(s => s.id === streamId);
            if (!stream || !stream.hls_url) {
                showAlert('找不到HLS播放地址', 'warning');
                return;
            }
            
            const hlsUrl = `${window.location.origin}${stream.hls_url}`;
            
            try {
                const response = await fetch(hlsUrl);
                if (response.ok) {
                    const playlist = await response.text();
                    
                    // 检查playlist是否包含segment信息
                    const hasSegments = playlist.includes('.ts');
                    
                    let message = `
                        <strong>HLS播放测试</strong><br>
                        ✅ <strong>播放列表可访问</strong><br>
                        <strong>URL:</strong> ${hlsUrl}<br>
                        <strong>包含视频片段:</strong> ${hasSegments ? '✅ 是' : '❌ 否'}<br>
                        <strong>播放列表内容:</strong><br>
                        <code class="small">${escapeHtml(playlist.substring(0, 300))}${playlist.length > 300 ? '...' : ''}</code>
                    `;
                    
                    showAlert(message, hasSegments ? 'success' : 'warning');
                } else {
                    showAlert(`HLS播放测试失败: HTTP ${response.status}`, 'danger');
                }
            } catch (error) {
                showAlert(`HLS播放测试失败: ${error.message}`, 'danger');
            }
        }

        function showHelp() {
            showAlert(`
                <strong>使用说明：</strong><br>
                1. 点击"添加新流"添加MPD流配置<br>
                2. 配置流名称、MPD地址和ClearKey许可证（如需要）<br>
                3. 点击"启动"按钮开始转换<br>
                4. 复制生成的HLS地址到播放器中使用
            `, 'info');
        }
    </script>
</body>
</html>
