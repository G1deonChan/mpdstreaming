# ClearKeyè§£å¯†ç®¡é“æ¶æ„æ–‡æ¡£

## æ¦‚è¿°

åŸºäºæ‚¨çš„æ­£ç¡®æŒ‡å‡ºï¼ŒFFmpegæœ¬èº«ä¸å…·å¤‡ClearKeyè§£å¯†çš„èƒ½åŠ›ã€‚æˆ‘ä»¬å·²ç»é‡æ–°è®¾è®¡äº†è§£å¯†æ¶æ„ï¼Œä½¿ç”¨å¤–éƒ¨å·¥å…·è¿›è¡ŒClearKeyè§£å¯†ï¼Œç„¶åé€šè¿‡ç®¡é“å°†è§£å¯†åçš„æµä¼ é€’ç»™FFmpegè¿›è¡ŒHLSè½¬æ¢ã€‚

## æ¶æ„è®¾è®¡

### ğŸ”„ ç®¡é“æµç¨‹

```
[MPEG-DASHæµ] â†’ [å¤–éƒ¨è§£å¯†å™¨] â†’ [ç®¡é“] â†’ [FFmpeg] â†’ [HLSè¾“å‡º]
      â†“              â†“           â†“         â†“          â†“
   åŠ å¯†çš„MPD    yt-dlp/è‡ªå®šä¹‰   stdout   stdin    playlist.m3u8
   + ClearKey     è§£å¯†å·¥å…·      æµä¼ è¾“    æ¥æ”¶      + segments
```

### ğŸ› ï¸ æŠ€æœ¯å®ç°

#### 1. å¤–éƒ¨è§£å¯†å™¨ (`decrypt_dash.py`)

**ç®¡é“æ¨¡å¼æ–°åŠŸèƒ½:**
- `--output-format pipe`: è¾“å‡ºåˆ°stdoutè€Œéæ–‡ä»¶
- `--pipe-format ts`: è¾“å‡ºMPEG-TSæ ¼å¼ä¾›FFmpegå¤„ç†
- æ”¯æŒyt-dlpçš„ClearKeyè§£å¯†èƒ½åŠ›

**ä½¿ç”¨æ–¹å¼:**
```bash
python decrypt_dash.py [MPD_URL] --license-key [KEY_ID:KEY] --output-format pipe --pipe-format ts
```

#### 2. ç®¡é“è¿æ¥ (`app.py`)

**æ–°å¢æ–¹æ³•:**
- `_create_hls_with_decryption_pipe()`: åˆ›å»ºè§£å¯†ç®¡é“
- `_monitor_decryption_pipe()`: ç›‘æ§åŒè¿›ç¨‹çŠ¶æ€
- `_restart_decryption_pipe()`: é‡å¯ç®¡é“æµç¨‹

**è¿›ç¨‹ç®¡ç†:**
```python
# å¯åŠ¨è§£å¯†è¿›ç¨‹
decrypt_process = subprocess.Popen(decrypt_cmd, stdout=subprocess.PIPE, ...)

# å¯åŠ¨FFmpegè¿›ç¨‹ï¼Œè¿æ¥è§£å¯†è¾“å‡º
ffmpeg_process = subprocess.Popen(ffmpeg_cmd, stdin=decrypt_process.stdout, ...)

# å…³é—­è§£å¯†è¿›ç¨‹çš„stdouté¿å…ç®¡é“é˜»å¡
decrypt_process.stdout.close()
```

## ğŸ¯ ä¼˜åŠ¿å¯¹æ¯”

### åŸæœ‰æ–¹æ¡ˆé—®é¢˜:
- âŒ FFmpegçš„`-decryption_key`å‚æ•°æ”¯æŒæœ‰é™
- âŒ éœ€è¦ä¸´æ—¶æ–‡ä»¶å­˜å‚¨ï¼Œå¢åŠ I/Oå¼€é”€
- âŒ ä¸¤æ­¥å¤„ç†ï¼šè§£å¯†â†’è½¬æ¢ï¼Œæ•ˆç‡ä½

### æ–°ç®¡é“æ–¹æ¡ˆä¼˜åŠ¿:
- âœ… ä½¿ç”¨yt-dlpçš„æˆç†ŸClearKeyè§£å¯†èƒ½åŠ›
- âœ… æµå¼å¤„ç†ï¼Œæ— éœ€ä¸´æ—¶æ–‡ä»¶
- âœ… å®æ—¶è§£å¯†+è½¬æ¢ï¼Œæ•ˆç‡é«˜
- âœ… æ›´å¥½çš„é”™è¯¯å¤„ç†å’Œç›‘æ§

## ğŸ”§ è¯¦ç»†é…ç½®

### è§£å¯†å‘½ä»¤æ„å»º:
```python
decrypt_cmd = [
    'python', 'decrypt_dash.py',
    mpd_url,
    '--license-key', license_key,
    '--output-format', 'pipe',
    '--pipe-format', 'ts'
]
```

### FFmpegç®¡é“å‘½ä»¤:
```python
ffmpeg_cmd = [
    'ffmpeg', '-y',
    '-f', 'mpegts',        # è¾“å…¥æ ¼å¼
    '-i', 'pipe:0',        # ä»stdinè¯»å–
    '-c:v', 'libx264',     # è§†é¢‘ç¼–ç 
    '-c:a', 'aac',         # éŸ³é¢‘ç¼–ç 
    '-f', 'hls',           # è¾“å‡ºHLSæ ¼å¼
    # ... HLSå‚æ•°
    'playlist.m3u8'
]
```

## ğŸ” ç›‘æ§ä¸é”™è¯¯å¤„ç†

### åŒè¿›ç¨‹ç›‘æ§:
- åŒæ—¶ç›‘æ§è§£å¯†è¿›ç¨‹å’ŒFFmpegè¿›ç¨‹
- ä»»ä¸€è¿›ç¨‹å¼‚å¸¸éƒ½ä¼šè§¦å‘é‡å¯é€»è¾‘
- æ™ºèƒ½é”™è¯¯åˆ†æå’Œé‡è¯•ç­–ç•¥

### é”™è¯¯å¤„ç†å¢å¼º:
```python
def _analyze_ffmpeg_error(output, return_code):
    # åˆ†æç½‘ç»œé”™è¯¯ã€æ ¼å¼é”™è¯¯ã€æƒé™é”™è¯¯ç­‰
    # è¿”å›äººç±»å¯è¯»çš„é”™è¯¯æè¿°

def _should_retry_error(error_analysis, current_restarts):
    # æ ¹æ®é”™è¯¯ç±»å‹å†³å®šæ˜¯å¦é‡è¯•
    # 403/404ä¸é‡è¯•ï¼Œç½‘ç»œé”™è¯¯é™åˆ¶é‡è¯•æ¬¡æ•°

def _get_retry_delay(error_analysis, retry_count):
    # ç½‘ç»œé”™è¯¯ä½¿ç”¨æŒ‡æ•°é€€é¿ç­–ç•¥
    # å…¶ä»–é”™è¯¯ä½¿ç”¨å›ºå®šå»¶è¿Ÿ
```

## ğŸ§ª æµ‹è¯•éªŒè¯

è¿è¡Œæµ‹è¯•è„šæœ¬éªŒè¯åŠŸèƒ½:
```bash
python test_pipe_decryption.py
```

æµ‹è¯•è¦†ç›–:
- âœ… è„šæœ¬è¯­æ³•æ£€æŸ¥
- âœ… å‘½ä»¤æ„å»ºéªŒè¯
- âœ… FFmpegå¯ç”¨æ€§æ£€æŸ¥
- âœ… æµè¿æ¥æ€§æµ‹è¯•
- âœ… é”™è¯¯åˆ†æåŠŸèƒ½

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### å¯åŠ¨åŠ å¯†æµ:
```python
# é€šè¿‡APIæˆ–Webç•Œé¢æ·»åŠ æµ
{
    "name": "åŠ å¯†é¢‘é“",
    "url": "https://example.com/stream.mpd",
    "license_key": "key_id_hex:key_hex",
    "license_type": "clearkey"
}
```

### è‡ªåŠ¨å¤„ç†æµç¨‹:
1. æ£€æµ‹åˆ°ClearKeyè®¸å¯è¯
2. å¯åŠ¨è§£å¯†ç®¡é“æ¨¡å¼
3. yt-dlpè§£å¯†DASHæµ
4. ç®¡é“ä¼ è¾“åˆ°FFmpeg
5. FFmpegç”ŸæˆHLSè¾“å‡º
6. å®¢æˆ·ç«¯æ’­æ”¾HLSæµ

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜:

1. **yt-dlpä¸å¯ç”¨**
   - ç¡®ä¿å®‰è£…: `pip install yt-dlp`
   - æ£€æŸ¥ç‰ˆæœ¬: `yt-dlp --version`

2. **ç®¡é“è¿æ¥å¤±è´¥**
   - æ£€æŸ¥è¿›ç¨‹é—´é€šä¿¡
   - æŸ¥çœ‹é”™è¯¯æ—¥å¿—åˆ†æ

3. **ClearKeyæ ¼å¼é”™è¯¯**
   - ç¡®ä¿æ ¼å¼: `key_id:key`
   - æ£€æŸ¥hexç¼–ç æ­£ç¡®æ€§

### æ—¥å¿—ç¤ºä¾‹:
```
2025-08-30 21:41:17 - INFO - æ£€æµ‹åˆ°ClearKeyåŠ å¯†æµï¼Œä½¿ç”¨å¤–éƒ¨è§£å¯†å™¨: stream_1
2025-08-30 21:41:17 - INFO - å¯åŠ¨è§£å¯†ç®¡é“: python decrypt_dash.py... | ffmpeg...
2025-08-30 21:41:20 - INFO - è§£å¯†ç®¡é“å·²æˆåŠŸå¯åŠ¨ (stream_id: stream_1)
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### ç®¡é“ä¼˜åŠ¿:
- ğŸš€ æµå¼å¤„ç†ï¼Œå‡å°‘å»¶è¿Ÿ
- ğŸ’¾ èŠ‚çœç£ç›˜I/Oå’Œå­˜å‚¨ç©ºé—´
- âš¡ å¹¶è¡Œè§£å¯†å’Œè½¬æ¢å¤„ç†
- ğŸ”„ å®æ—¶é”™è¯¯æ£€æµ‹å’Œæ¢å¤

### ç›‘æ§æŒ‡æ ‡:
- è¿›ç¨‹çŠ¶æ€ (running/error/stopped)
- é‡å¯æ¬¡æ•°ç»Ÿè®¡
- è¾“å‡ºæ–‡ä»¶ç”ŸæˆçŠ¶æ€
- é”™è¯¯ç±»å‹åˆ†æ

è¿™ä¸ªæ–°æ¶æ„çœŸæ­£è§£å†³äº†ClearKeyè§£å¯†çš„æ ¸å¿ƒé—®é¢˜ï¼Œæä¾›äº†ä¸“ä¸šçº§çš„æµåª’ä½“å¤„ç†èƒ½åŠ›ã€‚
